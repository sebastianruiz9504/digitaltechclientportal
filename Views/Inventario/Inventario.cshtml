
@using DigitalTechClientPortal.Models
@model InventarioVm

@{
    ViewData["Title"] = "Inventario";
    var ok = TempData["InventarioOk"] as string;
    var err = TempData["InventarioError"] as string;

    string EstadoClase(string estado)
    {
        if (string.IsNullOrWhiteSpace(estado)) return "bg-slate-200 text-black";
        if (estado.Contains("Activo", System.StringComparison.OrdinalIgnoreCase)) return "bg-green-100 text-green-800 ring-1 ring-green-300";
        if (estado.Contains("mantenimiento", System.StringComparison.OrdinalIgnoreCase)) return "bg-yellow-100 text-yellow-800 ring-1 ring-yellow-300";
        if (estado.Contains("Retirado", System.StringComparison.OrdinalIgnoreCase)) return "bg-red-100 text-red-800 ring-1 ring-red-300";
        return "bg-slate-200 text-black";
    }
}
<style>
    .report-card {
        position: relative;
        border-radius: 1.25rem;
        background: linear-gradient(135deg, rgba(248, 250, 252, 0.96), rgba(241, 245, 249, 0.96));
        border: 1px solid rgba(148, 163, 184, 0.45);
        box-shadow: 0 30px 60px -40px rgba(15, 23, 42, 0.55);
        overflow: hidden;
    }

    .report-card::before {
        content: "";
        position: absolute;
        inset: -55% 35% auto -35%;
        height: 280px;
        background: radial-gradient(circle at top left, rgba(59, 130, 246, 0.22), transparent 70%);
        pointer-events: none;
        opacity: 0.9;
    }

    .report-card::after {
        content: "";
        position: absolute;
        inset: 35% -45% -55%;
        background: radial-gradient(circle at bottom right, rgba(14, 165, 233, 0.14), transparent 65%);
        pointer-events: none;
        opacity: 0.9;
    }

    .report-card__inner {
        position: relative;
        z-index: 1;
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
    }

    .report-card__header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
    }

    .report-card__heading {
        display: flex;
        align-items: center;
        gap: 0.85rem;
    }

    .report-card__icon {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 2.5rem;
        height: 2.5rem;
        border-radius: 0.9rem;
        background: rgba(59, 130, 246, 0.12);
        color: #1d4ed8;
    }

    .report-card__title {
        font-weight: 600;
        font-size: 0.95rem;
        letter-spacing: 0.02em;
        color: #0f172a;
    }

    .report-card__subtitle {
        font-size: 0.75rem;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        color: #64748b;
    }

    .report-card__canvas {
        position: relative;
        height: 240px;
    }

    @@media (min-width: 1280px) {
        .report-card__canvas {
            height: 260px;
        }
    }

    .report-card__canvas canvas {
        border-radius: 1rem;
        background: rgba(255, 255, 255, 0.88);
    }

    .report-card__badge {
        display: inline-flex;
        align-items: center;
        gap: 0.4rem;
        padding: 0.35rem 0.85rem;
        border-radius: 9999px;
        font-size: 0.65rem;
        font-weight: 700;
        letter-spacing: 0.08em;
        text-transform: uppercase;
        border: 1px solid rgba(148, 163, 184, 0.4);
        transition: all 0.2s ease;
    }

    .report-card__badge--neutral {
        background: rgba(148, 163, 184, 0.18);
        color: #475569;
        border-color: rgba(148, 163, 184, 0.35);
    }

    .report-card__badge--alert {
        background: rgba(244, 63, 94, 0.18);
        color: #be123c;
        border-color: rgba(248, 113, 113, 0.4);
    }

    .report-card__badge--success {
        background: rgba(34, 197, 94, 0.18);
        color: #15803d;
        border-color: rgba(74, 222, 128, 0.45);
    }

    .sin-licencia-alert {
        display: flex;
        align-items: flex-start;
        gap: 0.75rem;
        border-radius: 1rem;
        padding: 0.9rem 1rem;
        border: 1px solid rgba(245, 158, 11, 0.35);
        background: rgba(253, 230, 138, 0.35);
        color: #854d0e;
        font-size: 0.8rem;
        line-height: 1.35rem;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.5);
    }

    .sin-licencia-alert--warning {
        border-color: rgba(245, 158, 11, 0.45);
        background: rgba(253, 230, 138, 0.45);
        color: #854d0e;
    }

    .sin-licencia-alert--info {
        border-color: rgba(59, 130, 246, 0.35);
        background: rgba(191, 219, 254, 0.45);
        color: #1e3a8a;
    }

    .sin-licencia-alert svg {
        flex-shrink: 0;
        width: 1rem;
        height: 1rem;
        margin-top: 0.2rem;
    }

    .sin-licencia-list {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        font-size: 0.9rem;
        color: #0f172a;
    }

    .sin-licencia-placeholder,
    .sin-licencia-empty,
    .sin-licencia-error {
        padding: 1rem 1.25rem;
        border-radius: 1rem;
        border: 1px dashed rgba(148, 163, 184, 0.4);
        background: rgba(248, 250, 252, 0.7);
    }

    .sin-licencia-error {
        border-style: solid;
        border-color: rgba(248, 113, 113, 0.45);
        background: rgba(254, 226, 226, 0.65);
        color: #b91c1c;
    }

    .sin-licencia-table-wrapper {
        border-radius: 1rem;
        border: 1px solid rgba(226, 232, 240, 0.8);
        background: rgba(248, 250, 252, 0.88);
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.5);
        overflow: hidden;
    }

    .sin-licencia-scroll {
        max-height: 22rem;
        overflow-y: auto;
    }

    .sin-licencia-table thead {
        background: rgba(226, 232, 240, 0.5);
        text-transform: uppercase;
        letter-spacing: 0.08em;
        font-size: 0.7rem;
        color: #475569;
    }

    .sin-licencia-table th,
    .sin-licencia-table td {
        padding: 0.85rem 1rem;
    }

    .sin-licencia-table tbody tr {
        transition: background-color 0.15s ease;
    }

    .sin-licencia-table tbody tr:hover {
        background: rgba(59, 130, 246, 0.08);
    }

    .sin-licencia-note {
        font-size: 0.7rem;
        letter-spacing: 0.05em;
        text-transform: uppercase;
        color: #475569;
    }
</style>

<div class="flex items-center justify-between mb-6">
    <div>
        <h2 class="text-2xl font-semibold tracking-tight text-black">Inventario</h2>
        <p class="text-sm text-slate-800">Gestión de equipos, usuarios y ubicaciones</p>
    </div>
</div>

@if (!string.IsNullOrEmpty(ok))
{
    <div class="mb-4 rounded-md bg-green-50 p-3 ring-1 ring-green-300 text-green-800">
        <div class="flex items-center gap-2">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M9 16.17l-3.59-3.58-1.41 1.41L9 19 20.59 7.41 19.17 6z"/></svg>
            <span>@ok</span>
        </div>
    </div>
}
@if (!string.IsNullOrEmpty(err))
{
    <div class="mb-4 rounded-md bg-red-50 p-3 ring-1 ring-red-300 text-red-800">
        <div class="flex items-center gap-2">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>
            <span>@err</span>
        </div>
    </div>
}

@if (Model.Categorias == null || !Model.Categorias.Any())
{
    <div class="rounded-lg bg-white p-6 shadow-sm ring-1 ring-slate-200">
        <div class="flex items-center gap-3 text-slate-900">
            <svg class="w-6 h-6 text-[#040d1c]" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2L2 7l10 5 10-5-10-5zm0 7l-10 5 10 5 10-5-10-5z"/></svg>
            <div>
                <div class="font-semibold text-black">No hay categorías configuradas</div>
                <div class="text-sm text-slate-800">Añade categorías en Dataverse para empezar</div>
            </div>
        </div>
    </div>
}
else
{
    <!-- Tabs -->
    <div class="flex items-center gap-2 mb-4 flex-wrap">
        @for (int i = 0; i < Model.Categorias.Count; i++)
        {
            var cat = Model.Categorias[i];
            <button class="tab-btn px-3 py-1.5 rounded-full text-sm font-medium @(i == 0 ? "bg-[#040d1c] text-white" : "bg-white text-black ring-1 ring-slate-300 hover:bg-slate-50")"
                    data-target="panel-@cat.Id" data-group="invTabs">
                @cat.Nombre
            </button>
        }
        <span class="flex-1"></span>
        <button class="tab-btn px-3 py-1.5 rounded-full text-sm font-medium bg-white text-black ring-1 ring-slate-300 hover:bg-slate-50"
                data-target="panel-usuarios" data-group="invTabs">
            Usuarios
        </button>
        <button class="tab-btn px-3 py-1.5 rounded-full text-sm font-medium bg-white text-black ring-1 ring-slate-300 hover:bg-slate-50"
                data-target="panel-ubicaciones" data-group="invTabs">
            Ubicaciones
        </button>
        <!-- NUEVO: Reportes -->
        <button class="tab-btn px-3 py-1.5 rounded-full text-sm font-medium bg-white text-black ring-1 ring-slate-300 hover:bg-slate-50"
                data-target="panel-reportes" data-group="invTabs" id="btnReportesTab">
            Reportes
        </button>
    </div>
}
    <!-- Panels -->
    <div class="space-y-6">
        @for (int i = 0; i < Model.Categorias.Count; i++)
        {
            var cat = Model.Categorias[i];
            var equipos = (Model.EquiposPorCategoria != null && Model.EquiposPorCategoria.ContainsKey(cat.Id))
                ? Model.EquiposPorCategoria[cat.Id]
                : new List<EquipoVm>();

            <div id="panel-@cat.Id" class="tab-panel @(i == 0 ? "" : "hidden")">
                <div class="rounded-lg bg-white shadow-sm ring-1 ring-slate-200 overflow-hidden">
                    <!-- Header con buscador por serial dentro de la categoría -->
                    <div class="px-4 py-3 border-b border-slate-200">
                        <div class="flex items-center justify-between gap-3">
                            <div class="flex items-center gap-2">
                                <svg class="w-5 h-5 text-[#040d1c]" viewBox="0 0 24 24" fill="currentColor"><path d="M4 6h16v2H4zM4 11h16v2H4zM4 16h16v2H4z"/></svg>
                                <span class="font-semibold text-black">@cat.Nombre</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="relative">
                                    <input type="text"
                                           class="cat-serial-search w-64 rounded-md border-slate-300 focus:border-[#040d1c] focus:ring-[#040d1c] px-3 py-2 text-sm text-black placeholder:text-slate-500"
                                           placeholder="Buscar por serial..."
                                           data-cat-id="@cat.Id" />
                                    <span class="pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 text-xs">Serial</span>
                                </div>
                                <button class="inline-flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium bg-[#040d1c] text-white hover:brightness-110"
                                        data-modal="addEquipoModal" data-categoria="@cat.Id">
                                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13H5v-2h14v2z"/></svg>
                                    Agregar equipo
                                </button>
                            </div>
                        </div>
                    </div>

                    @if (equipos == null || equipos.Count == 0)
                    {
                        <div class="p-6 text-slate-900">Sin equipos en esta categoría.</div>
                    }
                    else
                    {
                        <!-- Tabla simplificada: Marca, Serial, Ubicación, Asignado, Acciones -->
                        <div class="overflow-x-auto max-w-full">
                            <table class="w-full table-auto text-sm">
                                <thead class="bg-slate-100 text-black">
                                    <tr class="whitespace-nowrap">
                                        <th class="px-4 py-2 text-left">Marca</th>
                                        <th class="px-4 py-2 text-left">Serial</th>
                                        <th class="px-4 py-2 text-left">Ubicación</th>
                                        <th class="px-4 py-2 text-left">Asignado</th>
                                        <th class="px-4 py-2 text-right">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100" data-cat-table="@cat.Id">
                                    @foreach (var e in equipos)
                                    {
                                        <tr class="hover:bg-slate-50 align-top cat-row" data-serial="@e.Serial">
                                            <td class="px-4 py-2 text-black break-words">@e.Marca</td>
                                            <td class="px-4 py-2"><span class="font-mono text-sm text-black break-all">@e.Serial</span></td>
                                            <td class="px-4 py-2">
                                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-sky-100 text-sky-800 ring-1 ring-sky-300 break-words">@e.Ubicacion</span>
                                            </td>
                                            <td class="px-4 py-2 break-words">
  @if (!string.IsNullOrWhiteSpace(e.AsignadoNombre) || !string.IsNullOrWhiteSpace(e.AsignadoA))
                                                  {
    <div class="flex flex-col">
                                                        @if (!string.IsNullOrWhiteSpace(e.AsignadoNombre))
                                                        {
                                                            <span class="text-sm font-semibold text-black break-words">@e.AsignadoNombre</span>
                                                        }
                                                        @if (!string.IsNullOrWhiteSpace(e.AsignadoA))
                                                        {
                                                            <span class="text-xs text-slate-600 break-all">@e.AsignadoA</span>
                                                        }
                                                    </div>
                                                }
                                                else
                                                {
                                                    <span class="text-slate-500 text-sm">—</span>                                                }
                                                
                                            </td>
                                            <td class="px-4 py-2">
                                                <div class="flex justify-end gap-2 flex-wrap">
                                                    <button type="button"
                                                            class="inline-flex items-center gap-2 px-3 py-1.5 rounded-md text-sm font-medium bg-white text-black ring-1 ring-slate-300 hover:bg-slate-50 btn-ver-detalle-equipo"
                                                            data-id="@e.Id">
                                                        <svg class="w-4 h-4 text-[#040d1c]" viewBox="0 0 24 24" fill="currentColor"><path d="M12 6a9.77 9.77 0 019 6 9.77 9.77 0 01-9 6 9.77 9.77 0 01-9-6 9.77 9.77 0 019-6zm0 10a4 4 0 100-8 4 4 0 000 8z"/></svg>
                                                        Ver detalle
                                                    </button>
                                                    <form asp-action="EliminarEquipo" asp-controller="Inventario" method="post" onsubmit="return confirm('¿Eliminar este equipo?');">
                                                        @Html.AntiForgeryToken()
                                                        <input type="hidden" name="id" value="@e.Id" />
                                                        <button type="submit" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-md text-sm font-medium bg-red-600 text-white hover:bg-red-700">
                                                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M6 19c0 1.1.9 2 2 2h8a2 2 0 002-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                                                            Eliminar
                                                        </button>
                                                    </form>
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            </div>
        }

</div>
        <!-- Usuarios: búsqueda global + paginación -->
        <div id="panel-usuarios" class="tab-panel hidden">
            <div class="rounded-lg bg-white shadow-sm ring-1 ring-slate-200 overflow-hidden">
                <!-- Header: título + buscador global -->
                <div class="px-4 py-3 border-b border-slate-200 flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5 text-[#040d1c]" viewBox="0 0 24 24" fill="currentColor"><path d="M16 11c1.65 0 3-1.35 3-3s-1.35-3-3-3-3 1.35-3 3 1.35 3 3 3zm-8 0c1.65 0 3-1.35 3-3S9.65 5 8 5 5 6.35 5 8s1.35 3 3 3zm0 2c-2.67 0-8 1.34-8 4v2h10v-2c0-2.66-3.33-4-6-4zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.95 1.97 3.45v2h8v-2c0-2.66-3.33-4-6-4z"/></svg>
                        <span class="font-semibold text-black">Usuarios del tenant</span>
                    </div>

                    <!-- Buscador global -->
                    <div class="flex items-center gap-2">
                        <div class="relative">
                            <input
                                type="text"
                                id="usuariosSearchInput"
                                class="w-72 rounded-md border-slate-300 focus:border-[#040d1c] focus:ring-[#040d1c] px-3 py-2 text-sm text-black placeholder:text-slate-500"
                                placeholder="Buscar por nombre en todo el tenant..."
                            />
                            <span class="pointer-events-none absolute right-2 top-1/2 -translate-y-1/2 text-slate-400 text-xs">Nombre</span>
                        </div>
                        <button
                            type="button"
                            id="usuariosSearchClear"
                            class="inline-flex items-center px-3 py-2 rounded-md text-sm font-medium bg-white text-black ring-1 ring-slate-300 hover:bg-slate-50"
                            title="Limpiar búsqueda"
                        >
                            Limpiar
                        </button>
                    </div>
                </div>

                @if (Model.UsuariosTenant == null || Model.UsuariosTenant.Count == 0)
                {
                    <div class="p-6 text-slate-900">Sin usuarios para mostrar.</div>
                }
                else
                {
                    <div class="overflow-x-auto max-w-full">
                        <table class="w-full table-auto text-sm" id="usuariosTable">
                            <thead class="bg-slate-100 text-black">
                                <tr class="whitespace-nowrap">
                                    <th class="px-4 py-2 text-left">Nombre</th>
                                    <th class="px-4 py-2 text-left">UPN</th>
                                    <th class="px-4 py-2 text-left">Correo</th>
                                    <th class="px-4 py-2 text-left">Departamento</th>
                                    <th class="px-4 py-2 text-right">Acciones</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100" id="usuariosTbody">
                                @foreach (var u in Model.UsuariosTenant)
                                {
                                    <tr class="hover:bg-slate-50 align-top">
                                        <td class="px-4 py-2 font-semibold text-black break-words">@u.DisplayName</td>
                                        <td class="px-4 py-2 text-slate-900 break-all">@u.UserPrincipalName</td>
                                        <td class="px-4 py-2 text-black break-all">@u.Mail</td>
                                        <td class="px-4 py-2 text-slate-900 break-words">@u.Department</td>
                                        <td class="px-4 py-2">
                                            <div class="flex justify-end">
                                                <button
                                                    type="button"
                                                    class="inline-flex items-center gap-2 px-3 py-1.5 rounded-md text-sm font-medium bg-[#040d1c] text-white hover:brightness-110 btn-ver-detalle"
                                                    data-user-id="@u.Id"
                                                    data-upn="@u.UserPrincipalName"
                                                >
                                                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 6a9.77 9.77 0 019 6 9.77 9.77 0 01-9 6 9.77 9.77 0 01-9-6 9.77 9.77 0 019-6zm0 10a4 4 0 100-8 4 4 0 000 8z"/></svg>
                                                    Ver detalle
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <!-- Paginación (Anterior/Siguiente) -->
                    <div class="flex items-center justify-between px-4 py-3 border-t border-slate-200" id="usuariosPager"
                         data-page="1" data-pagesize="25" data-skiptoken="">
                        <div class="text-sm text-slate-700">
                            Página <span id="usuariosPageLabel">1</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button type="button"
                                    id="usuariosPrevBtn"
                                    class="inline-flex items-center px-3 py-2 rounded-md text-sm font-medium bg-white text-black ring-1 ring-slate-300 hover:bg-slate-50 disabled:opacity-50"
                                    disabled>
                                Anterior
                            </button>
                            <button type="button"
                                    id="usuariosNextBtn"
                                    class="inline-flex items-center px-3 py-2 rounded-md text-sm font-medium bg-[#040d1c] text-white hover:brightness-110">
                                Siguiente
                            </button>
                        </div>
                    </div>
                }
            </div>

            @if (!string.IsNullOrWhiteSpace(Model.UsuarioSeleccionadoUpn))
            {
                <div class="mt-6 rounded-lg bg-white shadow-sm ring-1 ring-slate-200 overflow-hidden">
                    <div class="px-4 py-3 border-b border-slate-200">
                        <span class="font-semibold text-black">Dispositivos de @Model.UsuarioSeleccionadoUpn</span>
                    </div>
                    @if (Model.EquiposDelUsuarioSeleccionado == null || Model.EquiposDelUsuarioSeleccionado.Count == 0)
                    {
                        <div class="p-6 text-slate-900">Este usuario no tiene dispositivos asignados.</div>
                    }
                    else
                    {
                        <div class="overflow-x-auto max-w-full">
                            <table class="w-full table-auto text-sm">
                                <thead class="bg-slate-100 text-black">
                                    <tr class="whitespace-nowrap">
                                        <th class="px-4 py-2 text-left">Marca</th>
                                        <th class="px-4 py-2 text-left">Modelo</th>
                                        <th class="px-4 py-2 text-left">Serial</th>
                                        <th class="px-4 py-2 text-left">Estado</th>
                                        <th class="px-4 py-2 text-left">Compra</th>
                                        <th class="px-4 py-2 text-left">Ubicación</th>
                                        <th class="px-4 py-2 text-left">Notas</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    @foreach (var e in Model.EquiposDelUsuarioSeleccionado)
                                    {
                                        <tr class="hover:bg-slate-50 align-top">
                                            <td class="px-4 py-2 text-black break-words">@e.Marca</td>
                                            <td class="px-4 py-2 text-slate-900 break-words">@e.Modelo</td>
                                            <td class="px-4 py-2"><span class="font-mono text-sm text-black break-all">@e.Serial</span></td>
                                            <td class="px-4 py-2">
                                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium @(EstadoClase(e.Estado))">@e.Estado</span>
                                            </td>
                                            <td class="px-4 py-2 text-slate-900">@((e.FechaCompra.HasValue) ? e.FechaCompra.Value.ToString("yyyy-MM-dd") : "-")</td>
                                            <td class="px-4 py-2">
                                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium bg-sky-100 text-sky-800 ring-1 ring-sky-300 break-words">@e.Ubicacion</span>
                                            </td>
                                            <td class="px-4 py-2 text-slate-900 break-words">@e.Notas</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            }
        </div>

        <!-- Ubicaciones (sin cambios de lógica) -->
        <div id="panel-ubicaciones" class="tab-panel hidden">
            <div class="rounded-lg bg-white shadow-sm ring-1 ring-slate-200 overflow-hidden">
                <div class="px-4 py-3 border-b border-slate-200 flex items-center justify-between">
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5 text-[#040d1c]" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.1 2 5 5.1 5 9c0 5.2 7 13 7 13s7-7.8 7-13c0-3.9-3.1-7-7-7zm0 9.5c-1.4 0-2.5-1.1-2.5-2.5S10.6 6.5 12 6.5s2.5 1.1 2.5 2.5S13.4 11.5 12 11.5z"/></svg>
                        <span class="font-semibold text-black">Ubicaciones</span>
                    </div>
                    <button class="inline-flex items-center gap-2 px-3 py-2 rounded-md text-sm font-medium bg-[#040d1c] text-white hover:brightness-110"
                            data-modal="addUbicacionModal">
                        <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13H5v-2h14v2z"/></svg>
                        Crear ubicación
                    </button>
                </div>

                @if (Model.Ubicaciones == null || Model.Ubicaciones.Count == 0)
                {
                    <div class="p-6 text-slate-900">No hay ubicaciones registradas.</div>
                }
                else
                {
                    <div class="overflow-x-auto max-w-full">
                        <table class="w-full table-auto text-sm">
                            <thead class="bg-slate-100 text-black">
                                <tr class="whitespace-nowrap">
                                    <th class="px-4 py-2 text-left">Nombre</th>
                                    <th class="px-4 py-2 text-left">Descripción</th>
                                    <th class="px-4 py-2 text-right">Acciones</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                @foreach (var u in Model.Ubicaciones)
                                {
                                    <tr class="hover:bg-slate-50 align-top">
                                        <td class="px-4 py-2 font-semibold text-black break-words">@u.Nombre</td>
                                        <td class="px-4 py-2 text-slate-900 break-words">@u.Descripcion</td>
                                        <td class="px-4 py-2">
                                            <div class="flex justify-end gap-2 flex-wrap">
                                                <a class="inline-flex items-center gap-2 px-3 py-1.5 rounded-md text-sm font-medium bg-white text-black ring-1 ring-slate-300 hover:bg-slate-50"
                                                   asp-action="EquiposPorUbicacion" asp-route-ubicacionId="@u.Id">
                                                    Ver detalle
                                                </a>
                                                <button type="button" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-md text-sm font-medium bg-white text-black ring-1 ring-slate-300 hover:bg-slate-50 btn-edit-ubicacion" data-id="@u.Id">
                                                    Editar
                                                </button>
                                                <form asp-action="EliminarUbicacion" asp-controller="Inventario" method="post" onsubmit="return confirm('¿Eliminar esta ubicación?');">
                                                    @Html.AntiForgeryToken()
                                                    <input type="hidden" name="id" value="@u.Id" />
                                                    <button type="submit" class="inline-flex items-center gap-2 px-3 py-1.5 rounded-md text-sm font-medium bg-red-600 text-white hover:bg-red-700">
                                                        Eliminar
                                                    </button>
                                                </form>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
            </div>

            @if (Model.UbicacionSeleccionadaId.HasValue && Model.UbicacionSeleccionadaId.Value != Guid.Empty)
            {
                <div class="mt-6 rounded-lg bg-white shadow-sm ring-1 ring-slate-200 overflow-hidden">
                    <div class="px-4 py-3 border-b border-slate-200">
                        <span class="font-semibold text-black">Dispositivos en la ubicación seleccionada</span>
                    </div>
                    @if (Model.EquiposPorUbicacionSeleccionada == null || Model.EquiposPorUbicacionSeleccionada.Count == 0)
                    {
                        <div class="p-6 text-slate-900">No hay dispositivos en esta ubicación.</div>
                    }
                    else
                    {
                        <div class="overflow-x-auto max-w-full">
                            <table class="w-full table-auto text-sm">
                                <thead class="bg-slate-100 text-black">
                                    <tr class="whitespace-nowrap">
                                        <th class="px-4 py-2 text-left">Marca</th>
                                        <th class="px-4 py-2 text-left">Modelo</th>
                                        <th class="px-4 py-2 text-left">Serial</th>
                                        <th class="px-4 py-2 text-left">Estado</th>
                                        <th class="px-4 py-2 text-left">Compra</th>
                                        <th class="px-4 py-2 text-left">Asignado</th>
                                        <th class="px-4 py-2 text-left">Notas</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-slate-100">
                                    @foreach (var e in Model.EquiposPorUbicacionSeleccionada)
                                    {
                                        <tr class="hover:bg-slate-50 align-top">
                                            <td class="px-4 py-2 text-black break-words">@e.Marca</td>
                                            <td class="px-4 py-2 text-slate-900 break-words">@e.Modelo</td>
                                            <td class="px-4 py-2"><span class="font-mono text-sm text-black break-all">@e.Serial</span></td>
                                            <td class="px-4 py-2">
                                                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium @(EstadoClase(e.Estado))">@e.Estado</span>
                                            </td>
                                            <td class="px-4 py-2 text-slate-900">@((e.FechaCompra.HasValue) ? e.FechaCompra.Value.ToString("yyyy-MM-dd") : "-")</td>
                                            <td class="px-4 py-2">
                                               @if (!string.IsNullOrWhiteSpace(e.AsignadoNombre) || !string.IsNullOrWhiteSpace(e.AsignadoA))
                                                {
<div class="flex flex-col">
                                                        @if (!string.IsNullOrWhiteSpace(e.AsignadoNombre))
                                                        {
                                                            <span class="text-sm font-semibold text-black break-words">@e.AsignadoNombre</span>
                                                        }
                                                        @if (!string.IsNullOrWhiteSpace(e.AsignadoA))
                                                        {
                                                            <span class="text-xs text-slate-600 break-all">@e.AsignadoA</span>
                                                        }
                                                    </div>                                                }
                                                else { <span class="text-slate-500 text-sm">—</span> }
                                            </td>
                                            <td class="px-4 py-2 text-slate-900 break-words">@e.Notas</td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                </div>
            }
        </div>

        <!-- NUEVO: Reportes -->
        <div id="panel-reportes" class="tab-panel hidden">
 <div class="rounded-3xl bg-white/95 shadow-xl ring-1 ring-slate-200/70 overflow-hidden">
                 <div class="px-6 py-5 border-b border-slate-200/70 bg-gradient-to-r from-white via-slate-50 to-white">
                    <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                        <div class="flex items-center gap-3">
                            <span class="inline-flex h-11 w-11 items-center justify-center rounded-2xl bg-slate-900 text-white shadow-sm">
                                <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M5 3a1 1 0 00-1 1v16a1 1 0 001.447.894L9 19.118l3.553 1.776a1 1 0 00.894 0L17 19.118l3.553 1.776A1 1 0 0022 20V4a1 1 0 00-1.447-.894L17 4.882 13.447 3.106a1 1 0 00-.894 0L9 4.882 5.447 3.106A1 1 0 005 3zm1 2.382l2.553 1.276a1 1 0 00.894 0L13 4.882l3.553 1.776a1 1 0 00.894 0L20 5.618v12.764l-2.553-1.276a1 1 0 00-.894 0L13 19.118l-3.553-1.776a1 1 0 00-.894 0L6 18.382V5.382z"/></svg>
                            </span>
                            <div>
                                <span class="text-base font-semibold text-slate-900">Reportes del inventario</span>
                                <p class="text-sm text-slate-500">Analiza la distribución de equipos y detecta cuentas sin licencia.</p>
                            </div>
                        </div>
                        <a href="/Inventario/ExportEquiposCsv"
                           class="inline-flex items-center gap-2 rounded-full border border-slate-900/10 bg-slate-900 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:-translate-y-0.5 hover:shadow-lg">
                            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M13 5V3H7v2h6zm4 4V7h-6v2h6zm0 4v-2H7v2h10zm0 4v-2H7v2h10zm2 4H5c-1.103 0-2-.897-2-2V5c0-1.103.897-2 2-2h2v2H5v14h14v-2h2v2c0 1.103-.897 2-2 2zm0-10l4-4-4-4v3h-4v2h4v3z"/></svg>
                            Exportar CSV
 </a>
                    </div>
                    
                                  </div>

                <div class="p-6 space-y-6">
                    <div class="grid grid-cols-1 gap-6 lg:grid-cols-2 2xl:grid-cols-4">
                        <div class="report-card">
                            <div class="report-card__inner">
                                <div class="report-card__header">
                                    <div class="report-card__heading">
                                        <span class="report-card__icon">
                                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M4 3h16a1 1 0 011 1v3a1 1 0 01-.553.894L12 12.382 3.553 7.894A1 1 0 013 7V4a1 1 0 011-1zm0 6.618l8 4 8-4V20a1 1 0 01-1 1H5a1 1 0 01-1-1V9.618z"/></svg>
                                        </span>
                                        <div>
                                            <div class="report-card__subtitle">Visión general</div>
                                            <div class="report-card__title">Cantidad por categoría</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="report-card__canvas"><canvas id="chartPorCategoria"></canvas></div>
                            </div>
                        </div>

                        <div class="report-card">
                            <div class="report-card__inner">
                                <div class="report-card__header">
                                    <div class="report-card__heading">
                                        <span class="report-card__icon">
                                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a7 7 0 017 7c0 3.784-3.298 7.825-6.125 9.992a1.5 1.5 0 01-1.75 0C8.298 16.825 5 12.784 5 9a7 7 0 017-7zm0 9.5a2.5 2.5 0 100-5 2.5 2.5 0 000 5z"/></svg>
                                        </span>
                                        <div>
                                            <div class="report-card__subtitle">Cobertura</div>
                                            <div class="report-card__title">Cantidad por ubicación</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="report-card__canvas"><canvas id="chartPorUbicacion"></canvas></div>
                            </div>
                        </div>

                        <div class="report-card">
                            <div class="report-card__inner">
                                <div class="report-card__header">
                                    <div class="report-card__heading">
                                        <span class="report-card__icon">
                                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M4 5a1 1 0 011-1h14a1 1 0 011 1v4a3 3 0 01-3 3 3 3 0 003 3v4a1 1 0 01-1 1H5a1 1 0 01-1-1v-4a3 3 0 013-3 3 3 0 01-3-3V5zm2 1v3a1 1 0 001 1h10a1 1 0 001-1V6H6zm0 9v3h12v-3H6z"/></svg>
                                        </span>
                                        <div>
                                            <div class="report-card__subtitle">Fabricantes</div>
                                            <div class="report-card__title">Cantidad por marca</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="report-card__canvas"><canvas id="chartPorMarca"></canvas></div>
                            </div>
                        </div>

                        <div class="report-card">
                            <div class="report-card__inner">
                                <div class="report-card__header">
                                    <div class="report-card__heading">
                                        <span class="report-card__icon">
                                            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2a5 5 0 015 5c0 1.632-.626 3.115-1.653 4.222A9.986 9.986 0 0121 20h-2a8 8 0 00-16 0H1a9.986 9.986 0 015.653-8.778A5.992 5.992 0 017 7a5 5 0 015-5zm0 2a3 3 0 100 6 3 3 0 000-6z"/></svg>
                                        </span>
                                        <div>
                                            <div class="report-card__subtitle">Licenciamiento</div>
                                            <div class="report-card__title">Usuarios sin licencia</div>
                                        </div>
                                    </div>
                                    <span id="sinLicCountBadge" class="report-card__badge report-card__badge--neutral">—</span>
                                </div>
                                <div class="report-card__canvas"><canvas id="chartSinLicencia"></canvas></div>
                                
                            </div>
                        </div>
                    </div>

                    <div class="report-card sin-licencia-list">
                        <div class="report-card__inner">
                            <div class="report-card__header">
                                <div class="report-card__heading">
                                    <span class="report-card__icon">
                                        <svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor"><path d="M4 5a2 2 0 012-2h12a2 2 0 012 2v14l-4-3-4 3-4-3-4 3V5zm4 2v2h8V7H8zm0 4v2h5v-2H8z"/></svg>
                                    </span>
                                    <div>
                                        <div class="report-card__subtitle">Detalle accionable</div>
                                        <div class="report-card__title">Usuarios sin licencia detectados</div>
                                    </div>
                                </div>
                            </div>
                            <div id="sinLicListContainer" class="sin-licencia-placeholder">
                                Carga los reportes para ver el detalle de usuarios sin licencia.


                            </div>
                            <p id="sinLicListNote" class="sin-licencia-note hidden"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    
}

<!-- Modales -->
<div id="addEquipoModal" class="modal hidden fixed inset-0 z-50 bg-black/40 items-center justify-center">
  <div class="modal-content w-full max-w-2xl mx-4 rounded-lg bg-white shadow-xl">
    <div class="flex items-center justify-between px-4 py-3 border-b border-slate-200">
      <div class="flex items-center gap-2">
        <svg class="w-5 h-5 text-[#040d1c]" viewBox="0 0 24 24" fill="currentColor"><path d="M19 13H5v-2h14v2z"/></svg>
        <span class="font-semibold text-black">Agregar equipo</span>
      </div>
      <button class="modal-close p-2 rounded-md hover:bg-slate-100 text-black" aria-label="Cerrar">
        <svg class="w-5 h-5 text-slate-700" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59z"/></svg>
      </button>
    </div>
<form asp-action="CrearEquipo" asp-controller="Inventario" method="post" enctype="multipart/form-data">      @Html.AntiForgeryToken()
      <div class="px-4 py-4 space-y-4">
        <input type="hidden" name="CategoriaId" id="categoriaIdField" />
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-black">Marca</label>
            <input name="Marca" class="mt-1 w-full rounded-md border-slate-300 focus:border-[#040d1c] focus:ring-[#040d1c] text-black" required />
          </div>
          <div>
            <label class="block text-sm font-medium text-black">Modelo</label>
            <input name="Modelo" class="mt-1 w-full rounded-md border-slate-300 focus:border-[#040d1c] focus:ring-[#040d1c] text-black" required />
          </div>
          <div>
            <label class="block text-sm font-medium text-black">Serial</label>
            <input name="Serial" class="mt-1 w-full rounded-md border-slate-300 focus:border-[#040d1c] focus:ring-[#040d1c] text-black" />
          </div>
          <div>
            <label class="block text-sm font-medium text-black">Estado</label>
            <select name="Estado" class="mt-1 w-full rounded-md border-slate-300 focus:border-[#040d1c] focus:ring-[#040d1c] text-black">
              <option value="">(Sin estado)</option>
              <option value="645250000">Activo</option>
              <option value="645250001">En mantenimiento</option>
              <option value="645250002">Retirado</option>
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-black">Ubicación</label>
            <select name="UbicacionId" class="mt-1 w-full rounded-md border-slate-300 focus:border-[#040d1c] focus:ring-[#040d1c] text-black">
              <option value="">(Sin ubicación)</option>
              @if (Model.Ubicaciones != null && Model.Ubicaciones.Count > 0)
              {
                  foreach (var u in Model.Ubicaciones)
                  {
                      <option value="@u.Id">@u.Nombre</option>
                  }
              }
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-black">Propio o renta</label>
            <select name="PropioORenta" class="mt-1 w-full rounded-md border-slate-300 focus:border-[#040d1c] focus:ring-[#040d1c] text-black">
              <option value="">(Sin definir)</option>
              @foreach (var opt in Model.PropioORentaOptions)
              {
                  <option value="@opt.Value">@opt.Label</option>
              }
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-black">Fecha de compra</label>
            <input type="date" name="FechaCompra" class="mt-1 w-full rounded-md border-slate-300 focus:border-[#040d1c] focus:ring-[#040d1c] text-black" />
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-black">Asignar a (UPN)</label>
          <div class="relative mt-1">
            <input name="AsignadoA" id="asignadoAInput" class="w-full rounded-md border-slate-300 focus:border-[#040d1c] focus:ring-[#040d1c] text-black" placeholder="usuario@dominio.com" autocomplete="off" />
            <div id="asignadoASuggestions" class="absolute z-50 mt-1 w-full rounded-md bg-white shadow ring-1 ring-slate-300 hidden"></div>
          </div>
        </div>
        <div>
          <label class="block text-sm font-medium text-black">Notas</label>
          <textarea name="Notas" rows="3" class="mt-1 w-full rounded-md border-slate-300 focus:border-[#040d1c] focus:ring-[#040d1c] text-black" placeholder="Detalles, condiciones, etc."></textarea>
        </div>
      </div>
      <div>
          <label class="block text-sm font-medium text-black">Acta de entrega</label>
          <input type="file" name="ActaDeEntrega" accept=".pdf,image/*" class="mt-1 w-full text-sm text-black file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-slate-100 file:text-black hover:file:bg-slate-200" />
          <p class="mt-1 text-xs text-slate-600">Adjunta el acta en formato PDF o imagen.</p>
        </div>
      <div class="px-4 py-3 bg-slate-100 flex items-center justify-end gap-2">
        <button type="submit" class="inline-flex items-center gap-2 px-4 py-2 rounded-md text-sm font-medium bg-[#040d1c] text-white hover:brightness-110">
          Guardar
        </button>
        <button type="button" class="modal-close inline-flex items-center gap-2 px-4 py-2 rounded-md text-sm font-medium bg-white text-black shadow-sm ring-1 ring-slate-300 hover:bg-slate-50">
          Cancelar
        </button>
      </div>
    </form>
  </div>
</div>

<div id="detalleEquipoModal" class="modal hidden fixed inset-0 z-50 bg-black/40 items-center justify-center">
  <div class="modal-content w-full max-w-4xl mx-4 rounded-lg bg-white shadow-xl">
    <div class="flex items-center justify-between px-4 py-3 border-b border-slate-200">
      <div class="flex items-center gap-2">
        <svg class="w-5 h-5 text-[#040d1c]" viewBox="0 0 24 24" fill="currentColor"><path d="M3 17.25V21h3.75l11-11-3.75-3.75-11 11z"/></svg>
        <span class="font-semibold text-black">Detalle del equipo</span>
      </div>
      <button class="modal-close p-2 rounded-md hover:bg-slate-100 text-black" aria-label="Cerrar">
        <svg class="w-5 h-5 text-slate-700" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59z"/></svg>
      </button>
    </div>
<form asp-action="EditarEquipo" asp-controller="Inventario" method="post" id="detalleEquipoForm" enctype="multipart/form-data">      @Html.AntiForgeryToken()
      <div class="px-4 py-4 space-y-4">
        <input type="hidden" name="Id" id="detEquipoId" />
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-medium text-black">Categoría</label>
            <select name="CategoriaId" id="detCategoriaId" class="mt-1 w-full rounded-md border-slate-300 focus:border-[#040d1c] focus:ring-[#040d1c] text-black">
              @foreach (var c in Model.Categorias)
              {
                <option value="@c.Id">@c.Nombre</option>
              }
            </select>
          </div>
          <div>
            <label class="block text-sm font-medium text-black">Estado</label>
            <select name="Estado" id="detEstado" class="mt-1 w-full rounded-md border-slate-300 focus:border-[#040d1c] focus:ring-[#040d1c] text-black">
              <option value="">(Sin estado)</option>
              <option value="645250000">Activo</option>
              <option value="645250001">En mantenimiento</option>
              <option value="645250002">Retirado</option>
            </select>
          </div>

          <div>
            <label class="block text-sm font-medium text-black">Marca</label>
            <input name="Marca" id="detMarca" class="mt-1 w-full rounded-md border-slate-300 focus:border-[#040d1c] focus:ring-[#040d1c] text-black" required />
          </div>
          <div>
            <label class="block text-sm font-medium text-black">Modelo</label>
            <input name="Modelo" id="detModelo" class="mt-1 w-full rounded-md border-slate-300 focus:border-[#040d1c] focus:ring-[#040d1c] text-black" required />
          </div>

          <div>
            <label class="block text-sm font-medium text-black">Serial</label>
            <input name="Serial" id="detSerial" class="mt-1 w-full rounded-md border-slate-300 focus:border-[#040d1c] focus:ring-[#040d1c] text-black" />
          </div>
          <div>
            <label class="block text-sm font-medium text-black">Ubicación</label>
            <select name="UbicacionId" id="detUbicacionId" class="mt-1 w-full rounded-md border-slate-300 focus:border-[#040d1c] focus:ring-[#040d1c] text-black">
              <option value="">(Sin ubicación)</option>
              @if (Model.Ubicaciones != null && Model.Ubicaciones.Count > 0)
              {
                foreach (var u in Model.Ubicaciones)
                {
                  <option value="@u.Id">@u.Nombre</option>
                }
              }
            </select>
          </div>
 <div>
            <label class="block text-sm font-medium text-black">Propio o renta</label>
            <select name="PropioORenta" id="detPropioOrenta" class="mt-1 w-full rounded-md border-slate-300 focus:border-[#040d1c] focus:ring-[#040d1c] text-black">
              <option value="">(Sin definir)</option>
              @foreach (var opt in Model.PropioORentaOptions)
              {
                <option value="@opt.Value">@opt.Label</option>
              }
            </select>
          </div>
          <div class="md:col-span-2">
            <label class="block text-sm font-medium text-black">Asignado a (UPN)</label>
            <div class="relative mt-1">
              <input name="AsignadoA" id="detAsignadoA" class="w-full rounded-md border-slate-300 focus:border-[#040d1c] focus:ring-[#040d1c] text-black" autocomplete="off" placeholder="usuario@dominio.com" />
              <div id="detAsignadoASuggestions" class="absolute z-50 mt-1 w-full rounded-md bg-white shadow ring-1 ring-slate-300 hidden"></div>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-black">Fecha de compra</label>
            <input type="date" name="FechaCompra" id="detFechaCompra" class="mt-1 w-full rounded-md border-slate-300 focus:border-[#040d1c] focus:ring-[#040d1c] text-black" />
          </div>
        </div>

        <div>
          <label class="block text-sm font-medium text-black">Hoja de vida / Notas</label>
          <textarea name="Notas" id="detNotas" rows="8" class="mt-1 w-full rounded-md border-slate-300 focus:border-[#040d1c] focus:ring-[#040d1c] text-black" placeholder="Registro detallado, mantenimientos, accesorios, incidencias, etc."></textarea>
          <p class="mt-2 text-xs text-slate-600">Este campo admite contenido extenso. Asegúrate de guardar los cambios.</p>
        </div>
      </div>
       <div>
          <label class="block text-sm font-medium text-black">Acta de entrega</label>
          <input type="file" name="ActaDeEntrega" id="detActaDeEntrega" accept=".pdf,image/*" class="mt-1 w-full text-sm text-black file:mr-4 file:py-2 file:px-4 file:rounded-md file:border-0 file:text-sm file:font-medium file:bg-slate-100 file:text-black hover:file:bg-slate-200" />
          <div id="detActaActual" class="mt-2 text-sm text-slate-700 hidden">
            <a id="detActaLink" class="text-[#040d1c] underline" target="_blank" rel="noopener">Ver acta actual</a>
            <span id="detActaNombre" class="block text-xs text-slate-500"></span>
          </div>
        </div>

      <div class="px-4 py-3 bg-slate-100 flex items-center justify-end gap-2">
        <button type="submit" class="inline-flex items-center gap-2 px-4 py-2 rounded-md text-sm font-medium bg-[#040d1c] text-white hover:brightness-110">
          Guardar cambios
        </button>
        <button type="button" class="modal-close inline-flex items-center gap-2 px-4 py-2 rounded-md text-sm font-medium bg-white text-black shadow-sm ring-1 ring-slate-300 hover:bg-slate-50">
          Cancelar
        </button>
      </div>
    </form>
  </div>
</div>

<div id="addUbicacionModal" class="modal hidden fixed inset-0 z-50 bg-black/40 items-center justify-center">
  <div class="modal-content w-full max-w-md mx-4 rounded-lg bg-white shadow-xl">
    <div class="flex items-center justify-between px-4 py-3 border-b border-slate-200">
      <div class="flex items-center gap-2">
        <svg class="w-5 h-5 text-[#040d1c]" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C8.1 2 5 5.1 5 9c0 5.2 7 13 7 13s7-7.8 7-13c0-3.9-3.1-7-7-7zm0 9.5c-1.4 0-2.5-1.1-2.5-2.5S10.6 6.5 12 6.5s2.5 1.1 2.5 2.5S13.4 11.5 12 11.5z"/></svg>
        <span class="font-semibold text-black">Crear ubicación</span>
      </div>
      <button class="modal-close p-2 rounded-md hover:bg-slate-100 text-black" aria-label="Cerrar">
        <svg class="w-5 h-5 text-slate-700" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59z"/></svg>
      </button>
    </div>
    <form asp-action="CrearUbicacion" asp-controller="Inventario" method="post">
      @Html.AntiForgeryToken()
      <div class="px-4 py-4 space-y-4">
        <div>
          <label class="block text-sm font-medium text-black">Nombre</label>
          <input name="nombre" class="mt-1 w-full rounded-md border-slate-300 focus:border-[#040d1c] focus:ring-[#040d1c] text-black" required placeholder="Ej. Piso 8" />
        </div>
        <div>
          <label class="block text-sm font-medium text-black">Descripción</label>
          <textarea name="descripcion" rows="3" class="mt-1 w-full rounded-md border-slate-300 focus:border-[#040d1c] focus:ring-[#040d1c] text-black" placeholder="Opcional"></textarea>
        </div>
      </div>
      <div class="px-4 py-3 bg-slate-100 flex items-center justify-end gap-2">
        <button type="submit" class="inline-flex items-center gap-2 px-4 py-2 rounded-md text-sm font-medium bg-[#040d1c] text-white hover:brightness-110">
          Crear
        </button>
        <button type="button" class="modal-close inline-flex items-center gap-2 px-4 py-2 rounded-md text-sm font-medium bg-white text-black shadow-sm ring-1 ring-slate-300 hover:bg-slate-50">
          Cancelar
        </button>
      </div>
    </form>
  </div>
</div>

<div id="usuarioDetalleModal" class="modal hidden fixed inset-0 z-50 bg-black/40 items-center justify-center">
  <div class="modal-content w-full max-w-3xl mx-4 rounded-lg bg-white shadow-xl">
    <div class="flex items-center justify-between px-4 py-3 border-b border-slate-200">
      <div class="flex items-center gap-2">
        <svg class="w-5 h-5 text-[#040d1c]" viewBox="0 0 24 24" fill="currentColor"><path d="M12 6a9.77 9.77 0 019 6 9.77 9.77 0 01-9 6 9.77 9.77 0 01-9-6 9.77 9.77 0 019-6zm0 10a4 4 0 100-8 4 4 0 000 8z"/></svg>
        <span class="font-semibold text-black">Detalle de usuario</span>
      </div>
      <button class="modal-close p-2 rounded-md hover:bg-slate-100 text-black" aria-label="Cerrar">
        <svg class="w-5 h-5 text-slate-700" viewBox="0 0 24 24" fill="currentColor"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59z"/></svg>
      </button>
    </div>
    <div id="usuarioDetalleContent" class="px-4 py-4"></div>
  </div>
</div>

@section Scripts {
<!-- Chart.js (para las gráficas de Reportes) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const actaDownloadUrl = '@Url.Action("Acta","Inventario")';

  // Tabs
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const target = btn.getAttribute('data-target');
      const group = btn.getAttribute('data-group');
      document.querySelectorAll('.tab-btn').forEach(b => {
        if (b.getAttribute('data-group') === group) {
          b.classList.remove('bg-[#040d1c]','text-white');
          b.classList.add('bg-white','text-black','ring-1','ring-slate-300');
        }
      });
      btn.classList.add('bg-[#040d1c]','text-white');
      btn.classList.remove('bg-white','text-black','ring-1','ring-slate-300');

      document.querySelectorAll('.tab-panel').forEach(p => p.classList.add('hidden'));
      const panel = document.getElementById(target);
      if (panel) panel.classList.remove('hidden');

      // NUEVO: cargar reportes al abrir la pestaña
      if (target === 'panel-reportes') {
        loadReportesOnce();
      }
    });
  });

  // Abrir modales (crear)
  document.querySelectorAll('[data-modal]').forEach(trigger => {
    trigger.addEventListener('click', () => {
      const id = trigger.getAttribute('data-modal');
      const categoriaId = trigger.getAttribute('data-categoria');
      const modal = document.getElementById(id);
      if (!modal) return;
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      if (categoriaId) {
        const hiddenField = document.getElementById('categoriaIdField');
        if (hiddenField) hiddenField.value = categoriaId;
      }
    });
  });

  // Cerrar modales
  document.querySelectorAll('.modal').forEach(modal => {
    modal.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal') || e.target.classList.contains('modal-close')) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
      }
    });
  });

  // Búsqueda por serial (por categoría, client-side)
  document.querySelectorAll('.cat-serial-search').forEach(input => {
    input.addEventListener('input', () => {
      const term = input.value.trim().toLowerCase();
      const catId = input.getAttribute('data-cat-id');
      const tbody = document.querySelector(`tbody[data-cat-table="${catId}"]`);
      if (!tbody) return;
      tbody.querySelectorAll('tr.cat-row').forEach(row => {
        const serial = (row.getAttribute('data-serial') || '').toLowerCase();
        const match = term.length === 0 || serial.includes(term);
        row.style.display = match ? '' : 'none';
      });
    });
  });

  // Ver detalle equipo (carga en modal amplio editable)
  document.querySelectorAll('.btn-ver-detalle-equipo').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.getAttribute('data-id');
      try {
        const res = await fetch(`/Inventario/Equipo?id=${encodeURIComponent(id)}`, { headers: { 'Accept':'application/json' }});
        if (!res.ok) { alert('No fue posible cargar el equipo.'); return; }
        const e = await res.json();
        document.getElementById('detEquipoId').value = e.id;
        document.getElementById('detCategoriaId').value = e.categoriaId;
        document.getElementById('detMarca').value = e.marca;
        document.getElementById('detModelo').value = e.modelo;
        document.getElementById('detSerial').value = e.serial;
        document.getElementById('detEstado').value = e.estado ?? '';
        document.getElementById('detUbicacionId').value = e.ubicacionId || '';
        document.getElementById('detAsignadoA').value = e.asignadoA || '';
           const propioSelect = document.getElementById('detPropioOrenta');
        if (propioSelect) propioSelect.value = (e.propioORenta ?? '').toString();
        document.getElementById('detFechaCompra').value = e.fechaCompra ? e.fechaCompra.substring(0,10) : '';
        document.getElementById('detNotas').value = e.notas || '';
const actaInput = document.getElementById('detActaDeEntrega');
        if (actaInput) actaInput.value = '';
        const actaContainer = document.getElementById('detActaActual');
        const actaLink = document.getElementById('detActaLink');
        const actaNombre = document.getElementById('detActaNombre');
        if (actaContainer && actaLink && actaNombre) {
          if (e.tieneActaDeEntrega) {
            actaContainer.classList.remove('hidden');
            actaLink.href = `${actaDownloadUrl}?id=${encodeURIComponent(id)}`;
            actaNombre.textContent = e.actaDeEntregaNombre || '';
          } else {
            actaContainer.classList.add('hidden');
            actaLink.removeAttribute('href');
            actaNombre.textContent = '';
          }
        }
        const modal = document.getElementById('detalleEquipoModal');
        modal.classList.remove('hidden'); modal.classList.add('flex');
      } catch {
        alert('Error cargando equipo.');
      }
    });
  });

  // Autocompletar UPN (Agregar equipo)
  const asignadoInput = document.getElementById('asignadoAInput');
  const suggestions = document.getElementById('asignadoASuggestions');
  let debounceTimer = null;
  const hideSuggestions = (el) => { el.classList.add('hidden'); el.innerHTML=''; };
  const showSuggestions = (el, items, setValue) => {
    el.innerHTML = '';
    items.forEach(it => {
      const a = document.createElement('button');
      a.type = 'button';
      a.className = 'w-full text-left px-3 py-2 text-sm hover:bg-slate-50 text-black';
      a.textContent = `${it.displayName} — ${it.upn}`;
      a.addEventListener('click', () => { setValue(it.upn); hideSuggestions(el); });
      el.appendChild(a);
    });
    el.classList.toggle('hidden', items.length === 0);
  };
  if (asignadoInput && suggestions) {
    asignadoInput.addEventListener('input', () => {
      const term = asignadoInput.value.trim();
      if (debounceTimer) clearTimeout(debounceTimer);
      if (term.length < 2) { hideSuggestions(suggestions); return; }
      debounceTimer = setTimeout(async () => {
        try {
          const res = await fetch(`/Inventario/BuscarUsuarios?term=${encodeURIComponent(term)}&top=8`, { headers: { 'Accept':'application/json' }});
          if (!res.ok) { hideSuggestions(suggestions); return; }
          const data = await res.json();
          const items = (data && data.value) ? data.value : (data.users || []);
          showSuggestions(suggestions, items, (v)=> asignadoInput.value = v);
        } catch { hideSuggestions(suggestions); }
      }, 250);
    });
    document.addEventListener('click', (e) => {
      if (!suggestions.contains(e.target) && e.target !== asignadoInput) hideSuggestions(suggestions);
    });
  }

  // Autocompletar UPN en modal detalle
  const detAsignadoInput = document.getElementById('detAsignadoA');
  const detSuggestions = document.getElementById('detAsignadoASuggestions');
  let detDebounce = null;
  if (detAsignadoInput && detSuggestions) {
    detAsignadoInput.addEventListener('input', () => {
      const term = detAsignadoInput.value.trim();
      if (detDebounce) clearTimeout(detDebounce);
      if (term.length < 2) { hideSuggestions(detSuggestions); return; }
      detDebounce = setTimeout(async () => {
        try {
          const res = await fetch(`/Inventario/BuscarUsuarios?term=${encodeURIComponent(term)}&top=8`, { headers: { 'Accept':'application/json' }});
          if (!res.ok) { hideSuggestions(detSuggestions); return; }
          const data = await res.json();
          const items = (data && data.value) ? data.value : (data.users || []);
          showSuggestions(detSuggestions, items, (v)=> detAsignadoInput.value = v);
        } catch { hideSuggestions(detSuggestions); }
      }, 250);
    });
    document.addEventListener('click', (e) => {
      if (!detSuggestions.contains(e.target) && e.target !== detAsignadoInput) hideSuggestions(detSuggestions);
    });
  }

  // -------- Usuarios: Búsqueda global + Paginación incremental --------
  const usuariosSearchInput = document.getElementById('usuariosSearchInput');
  const usuariosSearchClear = document.getElementById('usuariosSearchClear');
  const usuariosTbody       = document.getElementById('usuariosTbody');
  const usuariosPager       = document.getElementById('usuariosPager');
  const usuariosPageLabel   = document.getElementById('usuariosPageLabel');
  const usuariosPrevBtn     = document.getElementById('usuariosPrevBtn');
  const usuariosNextBtn     = document.getElementById('usuariosNextBtn');

  let usuariosSearchTimer = null;
  let usuariosSearchActive = false;
  // Historial de skipTokens para botón "Anterior"
  const skipStack = [];

  const renderUsuariosRows = (items) => {
    usuariosTbody.innerHTML = '';
    items.forEach(u => {
      const tr = document.createElement('tr');
      tr.className = 'hover:bg-slate-50 align-top';
      const upn = u.upn || u.userPrincipalName || '';
      tr.innerHTML = `
        <td class="px-4 py-2 font-semibold text-black break-words">${u.displayName || ''}</td>
        <td class="px-4 py-2 text-slate-900 break-all">${upn}</td>
        <td class="px-4 py-2 text-black break-all">${u.mail || ''}</td>
        <td class="px-4 py-2 text-slate-900 break-words">${u.department || ''}</td>
        <td class="px-4 py-2">
          <div class="flex justify-end">
            <button type="button"
                    class="inline-flex items-center gap-2 px-3 py-1.5 rounded-md text-sm font-medium bg-[#040d1c] text-white hover:brightness-110 btn-ver-detalle"
                    data-user-id="${u.id || ''}"
                    data-upn="${upn}">
              <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor"><path d="M12 6a9.77 9.77 0 019 6 9.77 9.77 0 01-9 6 9.77 9.77 0 01-9-6 9.77 9.77 0 019-6zm0 10a4 4 0 100-8 4 4 0 000 8z"/></svg>
              Ver detalle
            </button>
          </div>
        </td>
      `;
      usuariosTbody.appendChild(tr);
    });
    // Reenganchar "Ver detalle" en filas nuevas
    document.querySelectorAll('.btn-ver-detalle').forEach(btn => {
      btn.onclick = async () => {
        const userId = btn.getAttribute('data-user-id');
        const upn    = btn.getAttribute('data-upn');
        const detalleContent = document.getElementById('usuarioDetalleContent');
        detalleContent.innerHTML = '<div class="flex items-center gap-2 text-slate-800"><span class="animate-pulse">●</span> Cargando...</div>';
        try {
          const res  = await fetch(`/Inventario/UsuarioDetalle?userId=${encodeURIComponent(userId)}&upn=${encodeURIComponent(upn)}`, { headers: { 'X-Requested-With':'XMLHttpRequest' }});
          const html = await res.text();
          detalleContent.innerHTML = html;
          const modal = document.getElementById('usuarioDetalleModal');
          modal.classList.remove('hidden'); modal.classList.add('flex');
        } catch {
          detalleContent.innerHTML = '<div class="text-red-700">No fue posible cargar el detalle.</div>';
          const modal = document.getElementById('usuarioDetalleModal');
          modal.classList.remove('hidden'); modal.classList.add('flex');
        }
      };
    });
  };

  const updatePagerUI = (page, hasPrev, hasNext, nextSkipToken) => {
    usuariosPager?.setAttribute('data-page', String(page));
    usuariosPager?.setAttribute('data-skiptoken', nextSkipToken || '');
    if (usuariosPageLabel) usuariosPageLabel.textContent = String(page);
    if (usuariosPrevBtn) usuariosPrevBtn.disabled = !hasPrev;
    if (usuariosNextBtn) usuariosNextBtn.disabled = !hasNext;
  };

  // Página por skiptoken (Graph)
  const fetchUsuariosPage = async (skipToken, pageSize, page, force = false) => {
    if (usuariosSearchActive && !force) return;
    try {
      const url = `/Inventario/UsuariosPage?pageSize=${pageSize}&skipToken=${encodeURIComponent(skipToken || '')}`;
      const res = await fetch(url, { headers: { 'Accept': 'application/json' }});
      if (!res.ok) return;
      const data = await res.json();
      const items = (data && data.users) ? data.users : ((data.value) ? data.value : []);
      const nextSkip = data.nextSkipToken || '';

      renderUsuariosRows(items);

      const hasPrev = skipStack.length > 0;
      const hasNext = !!nextSkip;
      updatePagerUI(page, hasPrev, hasNext, nextSkip);
    } catch { /* silencioso */ }
  };

  // Botón Siguiente
  if (usuariosNextBtn) {
    usuariosNextBtn.addEventListener('click', async () => {
      const pageSize = parseInt(usuariosPager?.getAttribute('data-pagesize') || '25', 10);
      const page     = parseInt(usuariosPager?.getAttribute('data-page') || '1', 10);
      const currentSkip = usuariosPager?.getAttribute('data-skiptoken') || '';
      // Guardar skip actual para permitir "Anterior"
      skipStack.push(currentSkip);
      await fetchUsuariosPage(currentSkip, pageSize, page + 1);
    });
  }

  // Botón Anterior
  if (usuariosPrevBtn) {
    usuariosPrevBtn.addEventListener('click', async () => {
      if (skipStack.length === 0) return;
      const pageSize = parseInt(usuariosPager?.getAttribute('data-pagesize') || '25', 10);
      const page     = Math.max(parseInt(usuariosPager?.getAttribute('data-page') || '1', 10) - 1, 1);
      const prevSkip = skipStack.pop() || '';
      await fetchUsuariosPage(prevSkip, pageSize, page);
    });
  }

  // Búsqueda global (por nombre o UPN en todo el tenant)
  const doUsuariosSearch = async (term, top = 25) => {
    try {
      const res = await fetch(`/Inventario/BuscarUsuarios?term=${encodeURIComponent(term)}&top=${top}`, { headers: { 'Accept': 'application/json' }});
      if (!res.ok) return;
      const data = await res.json();
      const items = (data && data.value) ? data.value : (data.users || []);
      renderUsuariosRows(items);
    } catch { /* silencioso */ }
  };

  if (usuariosSearchInput) {
    usuariosSearchInput.addEventListener('input', () => {
      const term = usuariosSearchInput.value.trim();
      if (usuariosSearchTimer) clearTimeout(usuariosSearchTimer);
      if (term.length < 2) {
        usuariosSearchActive = false;
        usuariosPager?.classList.remove('opacity-50', 'pointer-events-none');
        // Volver a la primera página
        skipStack.length = 0;
        fetchUsuariosPage('', parseInt(usuariosPager?.getAttribute('data-pagesize') || '25', 10), 1, true);
        return;
      }
      usuariosSearchTimer = setTimeout(async () => {
        usuariosSearchActive = true;
        usuariosPager?.classList.add('opacity-50', 'pointer-events-none');
        await doUsuariosSearch(term, parseInt(usuariosPager?.getAttribute('data-pagesize') || '25', 10));
      }, 250);
    });
  }

  if (usuariosSearchClear) {
    usuariosSearchClear.addEventListener('click', () => {
      usuariosSearchInput.value = '';
      usuariosSearchActive = false;
      usuariosPager?.classList.remove('opacity-50', 'pointer-events-none');
      skipStack.length = 0;
      fetchUsuariosPage('', parseInt(usuariosPager?.getAttribute('data-pagesize') || '25', 10), 1, true);
    });
  }

  // Ver detalle usuario (filas iniciales renderizadas por el servidor)
  const detalleContent = document.getElementById('usuarioDetalleContent');
  document.querySelectorAll('.btn-ver-detalle').forEach(btn => {
    btn.addEventListener('click', async () => {
      const userId = btn.getAttribute('data-user-id');
      const upn = btn.getAttribute('data-upn');
      detalleContent.innerHTML = '<div class="flex items-center gap-2 text-slate-800"><span class="animate-pulse">●</span> Cargando...</div>';
      try {
        const res = await fetch(`/Inventario/UsuarioDetalle?userId=${encodeURIComponent(userId)}&upn=${encodeURIComponent(upn)}`, { headers: { 'X-Requested-With':'XMLHttpRequest' }});
        const html = await res.text();
        detalleContent.innerHTML = html;
        const modal = document.getElementById('usuarioDetalleModal');
        modal.classList.remove('hidden'); modal.classList.add('flex');
      } catch {
        detalleContent.innerHTML = '<div class="text-red-700">No fue posible cargar el detalle.</div>';
        const modal = document.getElementById('usuarioDetalleModal');
        modal.classList.remove('hidden'); modal.classList.add('flex');
      }
    });
  });

  // Auto-open tabs from query
  const params = new URLSearchParams(window.location.search);
  if (params.has('upn')) {
    document.querySelectorAll('.tab-btn').forEach(b => { if (b.getAttribute('data-target') === 'panel-usuarios') b.click(); });
  }
  if (params.has('ubicacionId')) {
    document.querySelectorAll('.tab-btn').forEach(b => { if (b.getAttribute('data-target') === 'panel-ubicaciones') b.click(); });
  }

  // Carga inicial de usuarios: primera página sin skipToken
  const usuariosPanel = document.getElementById('panel-usuarios');
  if (usuariosPanel) {
    const pageSize = parseInt(usuariosPager?.getAttribute('data-pagesize') || '25', 10);
    fetchUsuariosPage('', pageSize, 1, true);
  }

  // ========= NUEVO: Reportes =========
  let reportesLoaded = false;
  let chartCat, chartUbi, chartMarca, chartSinLic;
     const sinLicWarning = document.getElementById('sinLicWarning');
  const sinLicWarningText = document.getElementById('sinLicWarningText');
  const sinLicWarningIcon = document.getElementById('sinLicWarningIcon');
  const sinLicListContainer = document.getElementById('sinLicListContainer');
  const sinLicCountBadge = document.getElementById('sinLicCountBadge');
  const sinLicListNote = document.getElementById('sinLicListNote');
  const sinLicCountBadgeVariants = {
    neutral: ['report-card__badge--neutral'],
    success: ['report-card__badge--success'],
    alert: ['report-card__badge--alert']
  };
  const chartPalette = [
    { start: 'rgba(37, 99, 235, 0.95)', end: 'rgba(59, 130, 246, 0.8)', hover: 'rgba(37, 99, 235, 1)', border: 'rgba(37, 99, 235, 0.95)' },
    { start: 'rgba(2, 132, 199, 0.95)', end: 'rgba(14, 165, 233, 0.8)', hover: 'rgba(2, 132, 199, 1)', border: 'rgba(2, 132, 199, 0.95)' },
    { start: 'rgba(16, 185, 129, 0.95)', end: 'rgba(45, 212, 191, 0.8)', hover: 'rgba(16, 185, 129, 1)', border: 'rgba(16, 185, 129, 0.95)' },
    { start: 'rgba(234, 179, 8, 0.95)', end: 'rgba(250, 204, 21, 0.8)', hover: 'rgba(234, 179, 8, 1)', border: 'rgba(202, 138, 4, 0.95)' },
    { start: 'rgba(168, 85, 247, 0.95)', end: 'rgba(217, 70, 239, 0.8)', hover: 'rgba(168, 85, 247, 1)', border: 'rgba(168, 85, 247, 0.95)' },
    { start: 'rgba(239, 68, 68, 0.95)', end: 'rgba(248, 113, 113, 0.8)', hover: 'rgba(239, 68, 68, 1)', border: 'rgba(239, 68, 68, 0.95)' },
    { start: 'rgba(14, 116, 144, 0.95)', end: 'rgba(8, 145, 178, 0.8)', hover: 'rgba(14, 116, 144, 1)', border: 'rgba(14, 116, 144, 0.95)' },
    { start: 'rgba(71, 85, 105, 0.95)', end: 'rgba(100, 116, 139, 0.8)', hover: 'rgba(71, 85, 105, 1)', border: 'rgba(71, 85, 105, 0.95)' }
  ];

  const barValuePlugin = {
    id: 'reportBarValues',
    afterDatasetsDraw(chart) {
      const { ctx } = chart;
      ctx.save();
      chart.data.datasets.forEach((dataset, datasetIndex) => {
        const meta = chart.getDatasetMeta(datasetIndex);
        meta.data.forEach((element, index) => {
          const raw = dataset.data[index];
          const numericValue = Number(raw);
          if (!Number.isFinite(numericValue) || numericValue <= 0) {
            return;
          }
          const position = element.tooltipPosition();
          const fontFamily = Chart.defaults.font && Chart.defaults.font.family
            ? Chart.defaults.font.family
            : "'Inter', 'Segoe UI', sans-serif";
          ctx.font = `600 12px ${fontFamily}`;
          ctx.fillStyle = '#1f2937';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'bottom';
          ctx.fillText(numericValue.toLocaleString('es-MX'), position.x, position.y - 8);
        });
      });
      ctx.restore();
    }
  };

  if (window.Chart) {
    const computedFont = getComputedStyle(document.documentElement).fontFamily;
    Chart.defaults.font.family = computedFont || "'Inter', 'Segoe UI', sans-serif";
    Chart.defaults.font.size = 13;
    Chart.defaults.color = '#0f172a';
    Chart.register(barValuePlugin);
    if (Chart.defaults.plugins && Chart.defaults.plugins.tooltip) {
      Chart.defaults.plugins.tooltip.cornerRadius = 12;
    }
  }

  function escapeHtml(value) {
    if (typeof value !== 'string') return '';
    return value
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  function setUnlicensedCountBadge(text, variant = 'neutral') {
    if (!sinLicCountBadge) return;
    Object.values(sinLicCountBadgeVariants).forEach(arr => sinLicCountBadge.classList.remove(...arr));
    sinLicCountBadge.classList.add(...(sinLicCountBadgeVariants[variant] ?? sinLicCountBadgeVariants.neutral));
    sinLicCountBadge.textContent = text;
  }

  function updateUnlicensedCountBadge(total) {
    if (!Number.isFinite(total)) {
      setUnlicensedCountBadge('—', 'neutral');
      return;
    }
    const text = total === 1 ? '1 usuario' : `${total} usuarios`;
    const variant = total === 0 ? 'success' : 'alert';
    setUnlicensedCountBadge(text, variant);
  }

  function showUnlicensedUsersLoading() {
    if (sinLicListContainer) {
      sinLicListContainer.innerHTML = '<div class="sin-licencia-placeholder">Cargando usuarios sin licencia...</div>';
    }
    if (sinLicListNote) sinLicListNote.classList.add('hidden');
    setUnlicensedCountBadge('Cargando…', 'neutral');
  }

  function renderUnlicensedUsersError(message) {
    if (sinLicListContainer) {
      sinLicListContainer.innerHTML = `<div class="sin-licencia-error">${escapeHtml(message)}</div>`;
    }
    if (sinLicListNote) sinLicListNote.classList.add('hidden');
    setUnlicensedCountBadge('—', 'alert');
  }

  function renderUnlicensedUsersList(list, total) {
    if (!sinLicListContainer) return;
    const safeList = Array.isArray(list) ? list : [];
    if (safeList.length === 0) {
      sinLicListContainer.innerHTML = '<div class="sin-licencia-empty">No se encontraron usuarios sin licencia.</div>';
      updateUnlicensedCountBadge(Number.isFinite(total) ? total : 0);
      if (sinLicListNote) sinLicListNote.classList.add('hidden');
      return;
    }

    const rows = safeList.map(user => {
      const displayName = user.displayName ? escapeHtml(user.displayName) : (user.userPrincipalName ? escapeHtml(user.userPrincipalName) : 'Sin nombre');
      const upn = user.userPrincipalName ? escapeHtml(user.userPrincipalName) : '—';
      const mail = user.mail ? escapeHtml(user.mail) : '—';
      const department = user.department ? escapeHtml(user.department) : '—';
      return `
        <tr class="border-b border-slate-200/70 last:border-b-0 transition-colors hover:bg-slate-100/40">
          <td class="font-medium text-slate-900 align-top">${displayName}</td>
          <td class="align-top">
            <div class="flex flex-col gap-0.5">
              <span class="font-mono text-xs text-slate-700">${upn}</span>
              <span class="text-xs text-slate-500">${mail}</span>
            </div>
          </td>
          <td class="align-top text-slate-600">${department}</td>
        </tr>`;
    }).join('');

    sinLicListContainer.innerHTML = `
      <div class="sin-licencia-table-wrapper">
        <div class="sin-licencia-scroll">
          <table class="sin-licencia-table text-sm">
            <thead>
              <tr>
                <th class="text-left">Nombre</th>
                <th class="text-left">Usuario / Correo</th>
                <th class="text-left">Departamento</th>
              </tr>
            </thead>
            <tbody>
              ${rows}
            </tbody>
          </table>
        </div>
      </div>`;

    updateUnlicensedCountBadge(Number.isFinite(total) ? total : 0);

    if (sinLicListNote) {
      if (Number.isFinite(total) && total > safeList.length) {
        sinLicListNote.textContent = `Mostrando ${safeList.length} de ${total} usuarios sin licencia. Consulta el centro de administración de Microsoft 365 para revisar el resto.`;
        sinLicListNote.classList.remove('hidden');
      } else {
        sinLicListNote.classList.add('hidden');
      }
    }
  }
  const sinLicVariantClasses = {
    warning: ['sin-licencia-alert--warning'],
    info: ['sin-licencia-alert--info']
  };

  function applySinLicVariant(variant) {
    if (!sinLicWarning) return;
    const target = sinLicVariantClasses[variant] ?? sinLicVariantClasses.warning;
    Object.values(sinLicVariantClasses).forEach(arr => sinLicWarning.classList.remove(...arr));
    sinLicWarning.classList.add(...target);
    if (sinLicWarningIcon) {
 sinLicWarningIcon.classList.remove('text-amber-500', 'text-sky-500');
      sinLicWarningIcon.classList.add(variant === 'info' ? 'text-sky-500' : 'text-amber-500');
    }
  }

  function showSinLicMessage(message, variant = 'warning') {
    if (!sinLicWarning) return;
    applySinLicVariant(variant);
    if (sinLicWarningText && message) sinLicWarningText.textContent = message;
    sinLicWarning.classList.remove('hidden');
  }

  function showSinLicWarning(message) {
    showSinLicMessage(message, 'warning');
  }

  function showSinLicInfo(message) {
    showSinLicMessage(message, 'info');
  }

  function hideSinLicWarning() {
    if (!sinLicWarning) return;
    sinLicWarning.classList.add('hidden');
  }
  async function loadReportesOnce() {
    if (reportesLoaded) return;
    try {
       showUnlicensedUsersLoading();
      hideSinLicWarning();
      const res = await fetch('/Inventario/ReportesData', { headers: { 'Accept': 'application/json' } });
 if (!res.ok) {
        console.error('No se pudo cargar ReportesData');
        showSinLicWarning('No se pudo cargar la información. Comprueba el token y los permisos de Microsoft Graph.');
                renderUnlicensedUsersError('No se pudo cargar la lista de usuarios sin licencia.');

        return;
      }

      const data = await res.json();

      // Por Categoría
      const catLabels = (data.porCategoria || []).map(x => x.label || '(Sin categoría)');
      const catValues = (data.porCategoria || []).map(x => x.count || 0);
      chartCat = buildBarChart('chartPorCategoria', catLabels, catValues, chartCat);

      // Por Ubicación
      const ubiLabels = (data.porUbicacion || []).map(x => x.label || '(Sin ubicación)');
      const ubiValues = (data.porUbicacion || []).map(x => x.count || 0);
      chartUbi = buildBarChart('chartPorUbicacion', ubiLabels, ubiValues, chartUbi);

      // Por Marca
      const marcaLabels = (data.porMarca || []).map(x => x.label || '(Sin marca)');
      const marcaValues = (data.porMarca || []).map(x => x.count || 0);
      chartMarca = buildBarChart('chartPorMarca', marcaLabels, marcaValues, chartMarca);

      // Usuarios sin licencia (una sola barra)
      const sinLic = Number(data.usuariosSinLicencia ?? 0);
      const sinLicBackendWarning = data.usuariosSinLicenciaWarning;
   chartSinLic = buildBarChart('chartSinLicencia', ['Sin licencia'], [Number.isFinite(sinLic) ? sinLic : 0], chartSinLic);
      const usuariosSinLicenciaListado = Array.isArray(data.usuariosSinLicenciaListado) ? data.usuariosSinLicenciaListado : [];
      renderUnlicensedUsersList(usuariosSinLicenciaListado, Number.isFinite(sinLic) ? sinLic : 0);
      if (sinLicBackendWarning) {
        showSinLicWarning(sinLicBackendWarning);
      } else if (Number.isFinite(sinLic) && sinLic === 0) {
        showSinLicInfo('Todos los usuarios tienen al menos una licencia asignada.');
      } else {
        hideSinLicWarning();
      }
      reportesLoaded = true;
      
    } catch (e) {
      console.error('Error cargando reportes', e);
  showSinLicWarning('Ocurrió un error al consultar Microsoft Graph. Intenta actualizar la página o renovar la sesión.');
      renderUnlicensedUsersError('Ocurrió un error al intentar obtener la lista de usuarios sin licencia.');    }
  }

   function buildBarChart(canvasId, labels, values, previousChart) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return null;
    const context = canvas.getContext('2d');
    if (!context) return null;
    if (previousChart) {
      previousChart.destroy();
    }

    const palette = chartPalette.length > 0
      ? chartPalette
      : [{ start: 'rgba(148, 163, 184, 0.75)', end: 'rgba(148, 163, 184, 0.55)', hover: 'rgba(148, 163, 184, 0.95)', border: 'rgba(148, 163, 184, 1)' }];
    const paletteSize = palette.length;
    const defaultHeight = canvas.height || 260;
    const fillColors = labels.map((_, idx) => {
      const entry = palette[idx % paletteSize];
      if (!entry.start || !entry.end) {
        return entry.start ?? 'rgba(148, 163, 184, 0.75)';
      }
      const gradient = context.createLinearGradient(0, 0, 0, defaultHeight);
      gradient.addColorStop(0, entry.start);
      gradient.addColorStop(1, entry.end);
      return gradient;
    });
    const borderColors = labels.map((_, idx) => {
      const entry = palette[idx % paletteSize];
      return entry.border ?? entry.start ?? 'rgba(148, 163, 184, 1)';
    });
    const hoverColors = labels.map((_, idx) => {
      const entry = palette[idx % paletteSize];
      return entry.hover ?? entry.start ?? 'rgba(148, 163, 184, 0.95)';
    });

    return new Chart(canvas, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Cantidad',
data: values,
          backgroundColor: fillColors,
          borderColor: borderColors,
          hoverBackgroundColor: hoverColors,
          borderWidth: 1.6,
          borderRadius: 18,
          borderSkipped: false,
          maxBarThickness: 60,
          barPercentage: 0.65,
          categoryPercentage: 0.55        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        layout: {
          padding: { top: 28, right: 16, bottom: 12, left: 12 }
        },
        plugins: {
    legend: { display: false },
          tooltip: {
            backgroundColor: 'rgba(15, 23, 42, 0.92)',
            borderColor: 'rgba(226, 232, 240, 0.3)',
            borderWidth: 1,
            padding: 12,
            titleColor: '#f8fafc',
            bodyColor: '#e2e8f0',
            titleFont: { weight: '600', size: 13 },
            bodyFont: { size: 12 },
            displayColors: false,
            callbacks: {
              label(context) {
                const parsed = context.parsed && typeof context.parsed.y === 'number'
                  ? context.parsed.y
                  : context.parsed;
                const numericValue = Number(parsed);
                if (!Number.isFinite(numericValue)) {
                  return '';
                }
                return numericValue.toLocaleString('es-MX');
              }
            }
          }        },
        scales: {
          x: {
            grid: { display: false },
            ticks: {
              autoSkip: true,
              maxRotation: 0,
              minRotation: 0,
              color: '#475569',
              font: { weight: 600 }
            }
          },
          y: {
            beginAtZero: true,
            precision: 0,
            grid: { color: 'rgba(148, 163, 184, 0.2)', drawBorder: false, drawTicks: false },
            ticks: {
              color: '#475569',
              stepSize: 1,
              callback(value) {
                return Number.isInteger(value) ? Number(value).toLocaleString('es-MX') : null;
              },
              padding: 10
            }
          }
        },
        animation: {
          duration: 900,
          easing: 'easeOutQuart'
        }
      }
    });
  }
});
</script>
}

